import socket
import struct
import cv2
import numpy as np
import time
from ultralytics import YOLO
model = YOLO("yolov8n.pt")  # Hoáº·c model custom náº¿u báº¡n cÃ³
import torch
print(torch.version.cuda)


# Cáº¥u hÃ¬nh
HOST        = "0.0.0.0"
PORT        = 9999
RECV_TIMEOUT= 5.0    # giÃ¢y chá» giá»¯a cÃ¡c recv
WARMUP_FRAMES = 5    # sá»‘ frame Ä‘áº§u chá»‰ Ä‘á»c mÃ  khÃ´ng hiá»ƒn thá»‹

def receive_all(sock, size):
    """Nháº­n Ä‘Ãºng 'size' byte; raise ConnectionError náº¿u timeout hoáº·c socket Ä‘Ã³ng."""
    data = b''
    start = time.time()
    while len(data) < size:
        if time.time() - start > RECV_TIMEOUT:
            raise ConnectionError("âš ï¸ Timeout khi recv dá»¯ liá»‡u")
        try:
            packet = sock.recv(size - len(data))
        except socket.timeout:
            raise ConnectionError("âš ï¸ Timeout khi recv dá»¯ liá»‡u")
        if not packet:
            raise ConnectionError("âš ï¸ Socket Ä‘Ã£ Ä‘Ã³ng")
        data += packet
    return data

def handle_client(client, addr, cam_id):
    """Xá»­ lÃ½ luá»“ng nháº­n áº£nh tá»« ESP32, bá» warm-up frames trÆ°á»›c khi hiá»ƒn thá»‹."""
    print(f"âœ… Camera-{cam_id} Ä‘Ã£ káº¿t ná»‘i tá»« {addr}")
    client.settimeout(RECV_TIMEOUT)

    window_name = f"Camera-{cam_id}"

    # Warm-up: Ä‘á»c vÃ  bá» qua vÃ i frame Ä‘áº§u
    for i in range(WARMUP_FRAMES):
        raw_len = receive_all(client, 4)
        img_len = struct.unpack('<I', raw_len)[0]
        _ = receive_all(client, img_len)
        _ = receive_all(client, 4)
        print(f"ğŸ”§ Camera-{cam_id} Warm-up frame {i+1}/{WARMUP_FRAMES}")
        print(f"ğŸ¬ Camera-{cam_id} báº¯t Ä‘áº§u hiá»ƒn thá»‹ áº£nh")

    frame_count = 0
    start_time = time.time()

    try:
        while True:
            # 1) Nháº­n 4 byte Ä‘á»™ dÃ i
            raw_len = receive_all(client, 4)
            img_len = struct.unpack('<I', raw_len)[0]

            # 2) Nháº­n img_len byte áº£nh
            img_data = receive_all(client, img_len)

            # 3) Nháº­n 4 byte checksum
            raw_ck = receive_all(client, 4)
            recv_ck = struct.unpack('<I', raw_ck)[0]
            calc_ck = sum(img_data)
            if recv_ck != calc_ck:
                print("âŒ Checksum lá»—i â€“ bá» frame")
                continue

            # 4) Giáº£i mÃ£ & hiá»ƒn thá»‹
            img = cv2.imdecode(
                np.frombuffer(img_data, dtype=np.uint8),
                cv2.IMREAD_COLOR
                
            )
            if img is not None:
                # ğŸ§  YOLO detection
                results = model(img, verbose=False)
                for box in results[0].boxes.xyxy:
                    x1, y1, x2, y2 = map(int, box[:4])
                    cv2.rectangle(img, (x1, y1), (x2, y2), (0, 255, 0), 2)

                for i, cls_id in enumerate(results[0].boxes.cls):
                    cls_name = model.names[int(cls_id)]
                    x1, y1 = map(int, results[0].boxes.xyxy[i][:2])
                    cv2.putText(img, cls_name, (x1, y1 - 5),
                                cv2.FONT_HERSHEY_SIMPLEX, 0.5, (0, 255, 0), 1)

                cv2.imshow(window_name, img)
                frame_count += 1

            # Nháº¥n ESC Ä‘á»ƒ ngáº¯t
            if cv2.waitKey(1) == 27:
                print("â›” Nháº¥n ESC, dá»«ng client")
                break

    except ConnectionError as e:
        print(f"âš ï¸ Camera-{cam_id} máº¥t káº¿t ná»‘i:", e)
    finally:
        elapsed = time.time() - start_time
        fps = frame_count / elapsed if elapsed > 0 else 0
        print(f"ğŸ”’ ÄÃ³ng káº¿t ná»‘i Camera-{cam_id}. Frames: {frame_count}, FPS: {fps:.2f}\n")
        client.close()
        cv2.destroyAllWindows()

def run_server():
    server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    server.bind((HOST, PORT))
    server.listen(1)
    print(f"ğŸŸ¢ Server cháº¡y trÃªn {HOST}:{PORT}")

    try:
        while True:
            print("ğŸ”„ Chá» ESP32 káº¿t ná»‘i láº¡i...")
            client, addr = server.accept()

            try:
                id_byte = client.recv(1)
                if not id_byte:
                    print(f"âŒ Client {addr} khÃ´ng gá»­i ID")
                    client.close()
                    continue

                cam_id = id_byte[0]
                print(f"ğŸ†” ESP32 Camera-{cam_id} Ä‘Ã£ káº¿t ná»‘i tá»« {addr}")
                
                handle_client(client, addr, cam_id)

            except Exception as e:
                print(f"âš ï¸ Lá»—i khi nháº­n ID tá»« {addr}: {e}")
                client.close()

    except KeyboardInterrupt:
        print("âœ‹ Server dá»«ng thá»§ cÃ´ng")
    finally:
        server.close()
        cv2.destroyAllWindows()

if __name__ == "__main__":
    run_server()
